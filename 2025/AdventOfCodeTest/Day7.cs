using System.Collections.Concurrent;

namespace AdventOfCodeTest;

public class Day7
{
    public const string SampleData =
        ".......S.......\n...............\n.......^.......\n...............\n......^.^......\n...............\n.....^.^.^.....\n...............\n....^.^...^....\n...............\n...^.^...^.^...\n...............\n..^...^.....^..\n...............\n.^.^.^.^.^...^.\n...............";

    public const string PuzzleData =
        "......................................................................S......................................................................\n.............................................................................................................................................\n......................................................................^......................................................................\n.............................................................................................................................................\n.....................................................................^.^.....................................................................\n.............................................................................................................................................\n....................................................................^.^.^....................................................................\n.............................................................................................................................................\n...................................................................^.^...^...................................................................\n.............................................................................................................................................\n..................................................................^.^...^.^..................................................................\n.............................................................................................................................................\n.................................................................^.^.^.^...^.................................................................\n.............................................................................................................................................\n................................................................^...^...^...^................................................................\n.............................................................................................................................................\n...............................................................^.^.^.^.^.....^...............................................................\n.............................................................................................................................................\n..............................................................^.^.^.^...^.^.^.^..............................................................\n.............................................................................................................................................\n.............................................................^.^.^.^.^.^.^.^...^.............................................................\n.............................................................................................................................................\n............................................................^...^.^.^.^...^.....^............................................................\n.............................................................................................................................................\n...........................................................^...^.^.^.^.^.^.....^.^...........................................................\n.............................................................................................................................................\n..........................................................^.^.^.^.^.^.^.^.^.....^.^..........................................................\n.............................................................................................................................................\n.........................................................^.^.^.^.....^.^...^.^.^...^.........................................................\n.............................................................................................................................................\n........................................................^.^.....^.^.^.^.^...^...^...^........................................................\n.............................................................................................................................................\n.......................................................^...^.^.^.^.....^...^.^.^.^...^.......................................................\n.............................................................................................................................................\n......................................................^.^...^.^...^...^.^.^.^...^.^...^......................................................\n.............................................................................................................................................\n.....................................................^...^.^.^...^.^.^.^.^.^.^.^.....^.^.....................................................\n.............................................................................................................................................\n....................................................^.^.^.^.^...^.^...^.^.^.^.^.^...^.^.^....................................................\n.............................................................................................................................................\n...................................................^.....^.......^...^...^.^.^...^.^.^...^...................................................\n.............................................................................................................................................\n..................................................^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^...^..................................................\n.............................................................................................................................................\n.................................................^...^.^.^.^.^.^...^.^.....^.......^...^.^.^.................................................\n.............................................................................................................................................\n................................................^.^.^.^...^.^.^.^.^.....^...^...^.^.^...^.^.^................................................\n.............................................................................................................................................\n...............................................^.^...^.........^.^...^...^...^.^.^.^.....^...^...............................................\n.............................................................................................................................................\n..............................................^...^.^.^.^...^...^...^.^.^.^.^...^...^.......^.^..............................................\n.............................................................................................................................................\n.............................................^.^.^.....^.^.^.^.^.^...^.^.^.^...^.....^...^.^...^.............................................\n.............................................................................................................................................\n............................................^...^.^.^.^.^.^...^.....^.^...^.......^.......^.^.^.^............................................\n.............................................................................................................................................\n...........................................^.^...^.^.....^.....^.^.^.^...^.^.^.^.^.^.^...^...^.^.^...........................................\n.............................................................................................................................................\n..........................................^.......^.....^.^.....^.^.....^.^.^...^...^...^.^.....^.^..........................................\n.............................................................................................................................................\n.........................................^.^.^...^.^...^.^...^.^.^...^.^...^.^.^...^.^.^.^.^.^.^.^.^.........................................\n.............................................................................................................................................\n........................................^.^...^.....^.^.^.^.^.....^.^.^.^.^.^.........^...^.^.^.^.^.^........................................\n.............................................................................................................................................\n.......................................^.^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.......................................\n.............................................................................................................................................\n......................................^...^.^.^.^.^...^...^...^.^.^...^.^.^.^...^.^.....^.^.^.......^.^......................................\n.............................................................................................................................................\n.....................................^.^.^.^.^.^.^...^.^.^.^.^.^.^.......^.^.^.^.^.^...^.....^.^.^...^.^.....................................\n.............................................................................................................................................\n....................................^.^.......^.^.^...^...^...^...^.^...^.^...^...^.^.^.^.^...^.^.^.....^....................................\n.............................................................................................................................................\n...................................^...^.^.^.^.^.......^.......^.^...^.^.^.^...^...^...^...^.^.^...^...^.^...................................\n.............................................................................................................................................\n..................................^...^.^...^.^...^...^.....^.......^.......^.^.^...^...^...^...^.^...^.^.^..................................\n.............................................................................................................................................\n.................................^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.......^.^.^.^.^.^...^.^...^.^...^.^...^.^.................................\n.............................................................................................................................................\n................................^.^.^.^.^.^...^.^.^.^.^.^.^...^.^...^.......^.....^.^.......^.^...^.........^................................\n.............................................................................................................................................\n...............................^.^...^...^.^.^...^.^...^.^.^.^...^.^.^.^.^.......^.^.^.......^.^.^.^.^.^...^.^...............................\n.............................................................................................................................................\n..............................^.^.^.^.^.^.^.^.^...^.^.^...^.......^.^.......^...^.^.^...^.^.^...^.^...^.^.^...^..............................\n.............................................................................................................................................\n.............................^.^.^.....^.^.^...^.^.....^.......^.^.^.^.^.^.^.^.^...^...^.....^.^.^...^.......^.^.............................\n.............................................................................................................................................\n............................^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.....^.........^.^...^.^.^...^.....^.^.^.^............................\n.............................................................................................................................................\n...........................^...^.......^.^.^...........^.^.^.^.^.^.^.^.^.^.^...^.^.^...^.....^...^.^.^.^.....^...^...........................\n.............................................................................................................................................\n..........................^.....^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.......^.^.^.^.^.^.....^.^.^.^...^.^.^.^.^.^...^..........................\n.............................................................................................................................................\n.........................^...^.......^.^.^...^.^.^.....^...........^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^.........................\n.............................................................................................................................................\n........................^.^...^.^.^...^.^.^.^.....^.^...^.^.^...^.^.....^...............^.^.^.^...^.^.^.^.........^.^........................\n.............................................................................................................................................\n.......................^.^.....^.^.^.^.^.^.^.....^.^.^.^.^.^.....^.^.^...^.^.^...^.^.^.....^.....^.^...^.^.^.^.....^.^.......................\n.............................................................................................................................................\n......................^.^.^.^.^.......^.^.^.^.....^.^...^.^.^.^...^...^.......^...^.^.^...^.^.^...^.....^...^.^...^.^.^......................\n.............................................................................................................................................\n.....................^.....^.^.^.^.....^.^.^.^.....^.^...^.^.....^.^...^.^.^.^.....^...^.^.^.^...^.....^.^...^...^.^.^.^.....................\n.............................................................................................................................................\n....................^.^.^...^.^.^.^.^.^.^...^.....^.^.^...^.....^...^.....^.^.^...^.^.^.^.....^.^.^.^.^.^...^.^.^...^.^.^....................\n.............................................................................................................................................\n...................^.^.....^.^...^.......^.^.^.^.^.^.^.^.....^.....^.^.^.^.^...^...^.^.^.^.^...^...^...^.^.^.....^...^.^.^...................\n.............................................................................................................................................\n..................^.....^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^...^.^.^...^...^.^.^.^.^.^...^.^...^..................\n.............................................................................................................................................\n.................^.^...^.^.^.^.^...^.^.^...^.^.^.^.....^.^.^.^...^.^.^.^.^.....^...^.^.^.^...^.^.^...^...^...^.^.^.^.^.^.^.^.................\n.............................................................................................................................................\n................^.^.....^...^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.......^.^.^.^.....^...........^...^.^.^.^...^...^.^.^.^.^.^................\n.............................................................................................................................................\n...............^.^.^.....^...^...^...^...^.^.^.....^.....^.^.^.^.^.^.^.....^.^.^.^.^.^...^...^.^.....^...^.^.^...^.^.^...^.^.^...............\n.............................................................................................................................................\n..............^.^.^...^.....^.^.^.^.^...^.......^.^.....^.^.^...^...^...^.^.....^.^.^.^...^.^.^.^...^.^.^...^.....^...^.^.^...^..............\n.............................................................................................................................................\n.............^.......^...^...^...^...^.^...^...^.^.^.^.^...^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.............\n.............................................................................................................................................\n............^.^...^.^.^.^...^...^.^...^.^.^...^.^.^...^.^.^...^...^...^...^.^.^.....^.^.^...^.....^.^.^.^.....^.^.^.....^.....^.^............\n.............................................................................................................................................\n...........^...^.^.^.^...^.^.^.....^.^...^...^.......^.^.^.^.^.^.^.^...^.^.^.^.....^...^.^...^...^...^.^.^.^.^.....^.^...^...^.^.^...........\n.............................................................................................................................................\n..........^.^.^.....^.^.^.^.^.^...^.^.^.^.^.^.^.^...^...^...^...^.^.^.^.^.....^.........^.^.......^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^..........\n.............................................................................................................................................\n.........^.^.....^.^.^...^.^.....^.^.^...^...^.^.....^.^.......^.^.^...^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.....^...^.......^.^.........\n.............................................................................................................................................\n........^...^.^.^.^.^.....^...^.^.^...^.^.^.^...^.^.^.^...^.^.....^.^...^.^.^.^.^.^.^.^.......^.^.^.....^.^...^.....^...^.^.........^........\n.............................................................................................................................................\n.......^.^.^.^.^.^.^...^.^.....^.^.^.......^.^.^.^.^.^.^...^.......^.^...^...^...^.^.^.^...^...^...^.^.^.^...^.^.^.^.....^.^.^.^.....^.......\n.............................................................................................................................................\n......^.^.........^...^.^.^.....^.^.^.^.^.....^.^.^...^.^.....^.^.....^.^.^.^.^.^.^...^...^.^...^.^...^.^.^.^.^.^.^...^.^.^.....^.^.^.^......\n.............................................................................................................................................\n.....^.^.^.....^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.....^...^.^.^.^...^...^.^...^.^.^.^.^...^.^...^.^.^.^.^.^.^.....^.^.....\n.............................................................................................................................................\n....^...^...^.^.^.....^...^.....^.^.^.....^...^.^.^.^.^.....^.^.....^.^.....^.^.^...^.^.^...^.^.^.^.^.^...^.^.^.^...^.^...^.........^.^.^....\n.............................................................................................................................................\n...^...^.^.......^...^.^.^.^...^...^.^...^.^.^.^.^...^.^.^.^.........^.^...^.^.^.^.^.^.^.^...^.^.....^...^.^.^...^.^.^.^.......^.^.^.^...^...\n.............................................................................................................................................\n..^.^.......^.........^.^.^.^.^.^...^.^.^.^.^.^...^.......^.^...^...^...^.^.^.^.^...^.^.^.^...^.^...^.....^...^.....^...^.^.^.^.^.^.^.^.^.^..\n.............................................................................................................................................\n.^.^...^.^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.......^.^.......^.^.^.^.^.^...^.^...^.^...^.^...^.^.^.^.^.^.....^...^...^.^.^.^.^...^.^.^.^.^.\n.............................................................................................................................................";
    [Theory]
    [InlineData(SampleData, 21)]
    [InlineData(PuzzleData, 1573)]
    public void Part1(string input, long extexted)
    {
        var lines = input.Split('\n');
        var tachyons = new HashSet<int>
        {
            lines[0].IndexOf("S", StringComparison.Ordinal),
        };
        var numberOfSplits = 0;
        foreach (var line in lines[1..])
        {
            var outgoing = new HashSet<int>();
            foreach (var tachyon in tachyons.Where(i => i < line.Length && i >= 0))
            {
                switch (line[tachyon])
                {
                    case '.':
                        outgoing.Add(tachyon);
                        break;
                    case '^':
                        outgoing.Add(tachyon - 1);
                        outgoing.Add(tachyon + 1);
                        numberOfSplits++;
                        break;
                }
            }

            tachyons = outgoing;
        }

        Assert.Equal(extexted, numberOfSplits);
    }

    [Theory]
    [InlineData(SampleData, 40)]
    [InlineData(PuzzleData, 15_093_663_987_272)]
    public async Task Part2(string input, long extexted)
    {
        var lines = input.Split('\n');
        var calculated = new ConcurrentDictionary<(int, int), Task<long>>();
        var timelines = await GetTimeLines(lines[1..], lines[0].IndexOf("S", StringComparison.Ordinal), calculated);

        Assert.Equal(extexted, timelines);
    }

    private async Task<long> GetTimeLines(string[] line, int tachyon, ConcurrentDictionary<(int, int), Task<long>> calculated)
    {
        if (line.Length == 0)
        {
            calculated[(0, tachyon)] = Task.FromResult(1L);
            return 1;
        }

        if (tachyon < 0 || tachyon >= line[0].Length)
            return 0;

        return line[0][tachyon] switch
               {
                   '.' => await GetSingleValue(line, tachyon, calculated),
                   '^' => await GetSplittedValue(line, tachyon, calculated),
                   _ => throw new InvalidOperationException($"value: {line[tachyon]}"),
               };
    }
    private async Task<long> GetSplittedValue(string[] line, int tachyon, ConcurrentDictionary<(int, int), Task<long>> calculated)
    {
        var a = GetSingleValue(line, tachyon - 1, calculated);
        var b = GetSingleValue(line, tachyon + 1, calculated);
        await Task.WhenAll(a, b);
        return await a + await b;
    }

    private async Task<long> GetSingleValue(string[] line, int tachyon, ConcurrentDictionary<(int, int), Task<long>> calculated)
    {
        return await calculated.GetOrAdd((line.Length, tachyon), _ => GetTimeLines(line[1..], tachyon, calculated));
    }
}
